name: Protect Workflow Files

on:
  push:
    branches-ignore: [ master ]  # é™¤äº†masteråˆ†æ”¯å¤–çš„æ‰€æœ‰åˆ†æ”¯
    paths:
      - '.github/workflows/**'

jobs:
  protect-workflow:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # éœ€è¦è·å–å‰ä¸€ä¸ªæäº¤æ¥æ¯”è¾ƒ
        
    - name: Check workflow file changes
      run: |
        echo "âŒ æ£€æµ‹åˆ°åœ¨émasteråˆ†æ”¯ä¿®æ”¹å·¥ä½œæµæ–‡ä»¶ï¼"
        echo "åˆ†æ”¯: ${GITHUB_REF#refs/heads/}"
        echo "æäº¤: $GITHUB_SHA"
        
        # è·å–ä¿®æ”¹çš„å·¥ä½œæµæ–‡ä»¶
        changed_files=$(git diff --name-only HEAD~1 HEAD | grep '.github/workflows/' || true)
        
        if [ -n "$changed_files" ]; then
          echo "ä¿®æ”¹çš„å·¥ä½œæµæ–‡ä»¶:"
          echo "$changed_files"
          echo ""
          echo "ğŸš« å·¥ä½œæµæ–‡ä»¶åªèƒ½åœ¨masteråˆ†æ”¯ä¿®æ”¹ï¼"
          echo "è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤ä¿®å¤:"
          echo "1. åˆ‡æ¢åˆ°masteråˆ†æ”¯"
          echo "2. åœ¨masteråˆ†æ”¯è¿›è¡Œå·¥ä½œæµä¿®æ”¹"
          echo "3. æ¨é€åˆ°masteråˆ†æ”¯"
          echo "4. è‡ªåŠ¨åŒæ­¥å·¥ä½œæµä¼šå°†ä¿®æ”¹åŒæ­¥åˆ°æ‰€æœ‰releaseåˆ†æ”¯"
          
          # åˆ›å»ºä¸€ä¸ªIssueæ¥é€šçŸ¥
          echo "creating_issue=true" >> $GITHUB_ENV
          echo "branch_name=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
          echo "changed_files<<EOF" >> $GITHUB_ENV
          echo "$changed_files" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
        fi
        
        # è®©å·¥ä½œæµå¤±è´¥
        exit 1
        
    - name: Create Issue for Workflow Violation
      if: env.creating_issue == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸš« å·¥ä½œæµæ–‡ä»¶ä¿®æ”¹è¿è§„ - åˆ†æ”¯: ${{ env.branch_name }}`,
            body: `## âŒ æ£€æµ‹åˆ°è¿è§„æ“ä½œ
            
            **åˆ†æ”¯**: \`${{ env.branch_name }}\`
            **æäº¤**: \`${{ github.sha }}\`
            **æ—¶é—´**: \`${{ github.event.head_commit.timestamp }}\`
            
            ### ä¿®æ”¹çš„å·¥ä½œæµæ–‡ä»¶:
            \`\`\`
            ${{ env.changed_files }}
            \`\`\`
            
            ### ğŸš« é”™è¯¯åŸå› 
            å·¥ä½œæµæ–‡ä»¶åªèƒ½åœ¨ \`master\` åˆ†æ”¯ä¿®æ”¹ï¼
            
            ### âœ… æ­£ç¡®åšæ³•
            1. åˆ‡æ¢åˆ° \`master\` åˆ†æ”¯
            2. åœ¨ \`master\` åˆ†æ”¯è¿›è¡Œå·¥ä½œæµä¿®æ”¹
            3. æ¨é€åˆ° \`master\` åˆ†æ”¯
            4. è‡ªåŠ¨åŒæ­¥å·¥ä½œæµä¼šå°†ä¿®æ”¹åŒæ­¥åˆ°æ‰€æœ‰releaseåˆ†æ”¯
            
            ### ğŸ“‹ éœ€è¦å¤„ç†
            - [ ] æ’¤é”€å½“å‰åˆ†æ”¯çš„å·¥ä½œæµä¿®æ”¹
            - [ ] åœ¨masteråˆ†æ”¯é‡æ–°è¿›è¡Œä¿®æ”¹
            - [ ] ç¡®è®¤è‡ªåŠ¨åŒæ­¥æ­£å¸¸å·¥ä½œ
            
            ---
            *æ­¤Issueç”±ä¿æŠ¤å·¥ä½œæµè‡ªåŠ¨åˆ›å»º*`,
            labels: ['workflow-violation', 'urgent']
          });
          
          console.log('Created issue:', issue.data.html_url);
          
    - name: Fail the build
      run: |
        echo "ğŸš« æ„å»ºå¤±è´¥: å·¥ä½œæµæ–‡ä»¶åªèƒ½åœ¨masteråˆ†æ”¯ä¿®æ”¹"
        exit 1 